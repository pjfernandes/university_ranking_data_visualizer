<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>THE Latin America — UFF Analytics</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>

  <style>
    :root { --primary-color: #006064; --bg-color: #f3f4f6; --card-bg: #ffffff; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg-color); padding-bottom: 40px; }
    .app-header { background: linear-gradient(135deg, var(--primary-color) 0%, #00838f 100%); color: white; padding: 2rem 1rem; margin-bottom: 2rem; }
    .controls-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); margin-bottom: 24px; }
    .form-label { font-weight: 500; color: var(--primary-color); font-size: 0.9rem; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    @media(max-width: 1200px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media(max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--card-bg); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; transition: all 0.3s ease; }
    .chart-header { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: #fafafa; }
    .chart-title { font-weight: 700; color: var(--primary-color); font-size: 0.95rem; margin: 0; }
    .chart-body { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
    .stats-footer { background: #fdfdfd; border-top: 1px solid #eee; padding: 10px 15px; font-size: 0.75rem; color: #444; }
    .table-stats { font-size: 0.72rem; margin-top: 10px; background: white; width: 100%; }
    .trend-up { color: #2e7d32; font-weight: bold; }
    .trend-down { color: #c62828; font-weight: bold; }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container-fluid px-4">
      <h1>THE Latin America — UFF Analytics</h1>
      <div class="subtitle">Comparative Regional Dashboard (2016–2026)</div>
    </div>
  </header>

  <div class="container-fluid px-4">
    <div class="controls-card">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label"><i class="bi bi-building"></i> Compare UFF with:</label>
          <select id="compareSelect" class="form-select">
            <option value="">Select an university...</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><i class="bi bi-calendar-range"></i> Period:</label>
          <div class="input-group">
            <select id="minYear" class="form-select"></select>
            <span class="input-group-text bg-light text-muted">to</span>
            <select id="maxYear" class="form-select"></select>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label"><i class="bi bi-graph-up"></i> Visualization:</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="chartType" id="typeLine" value="line" checked>
            <label class="btn btn-outline-primary" for="typeLine"><i class="bi bi-bezier2"></i> Trends</label>
            <input type="radio" class="btn-check" name="chartType" id="typeBox" value="box">
            <label class="btn btn-outline-primary" for="typeBox"><i class="bi bi-box-seam"></i> Distribution</label>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label"><i class="bi bi-chat-left-text"></i> Data Labels:</label>
          <div class="d-flex gap-3 mt-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="annMode" id="annUff" value="uff" checked>
              <label class="form-check-label" for="annUff">UFF</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="annMode" id="annBoth" value="both">
              <label class="form-check-label" for="annBoth">Both</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="annMode" id="annNone" value="none">
              <label class="form-check-label" for="annNone">Off</label>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
          <div id="status" class="text-primary fw-bold small">
            <div class="spinner-border spinner-border-sm" role="status"></div> Loading datasets...
          </div>
          <div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-secondary me-2"><i class="bi bi-arrow-clockwise"></i> Reset</button>
            <button id="applyFilter" class="btn btn-primary px-4"><i class="bi bi-check2-circle"></i> Update Dashboard</button>
          </div>
        </div>
      </div>
    </div>
    <div id="charts" class="grid"></div>
  </div>

  <script>
    (async function () {
      const urls = [2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2026].map(y => ({
        year: y, url: `https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/refs/heads/main/times_higher_education/the_la_${y}.csv`
      }));

      const uffName = "Universidade Federal Fluminense";
      let rows = [];
      let allFoundMetrics = new Set();

      const parseVal = v => {
        if (!v || v === "–" || v === "" || v === "null") return NaN;
        let s = String(v).replace(/,/g, ".").trim();
        let m = s.match(/-?\d+(\.\d+)?/);
        return m ? parseFloat(m[0]) : NaN;
      };

      const fmt = v => (isNaN(v) || v === null) ? '-' : parseFloat(v).toFixed(1);

      // Função para abreviar nomes longos (apenas para o Boxplot)
      const abbreviate = (name) => {
        if (!name || name.length < 15) return name;
        const words = name.split(' ');
        if (words.length < 2) return name;
        return words[0] + ' ' + words.slice(1).map(w => w[0].toUpperCase() + '.').join('');
      };

      const calculateMK = (data) => {
        const d = data.filter(v => !isNaN(v));
        if (d.length < 4) return { text: "N/A", trend: "" };
        let S = 0;
        for (let i = 0; i < d.length - 1; i++) {
          for (let j = i + 1; j < d.length; j++) S += Math.sign(d[j] - d[i]);
        }
        const varS = (d.length * (d.length - 1) * (2 * d.length + 5)) / 18;
        const Z = S > 0 ? (S - 1) / Math.sqrt(varS) : (S < 0 ? (S + 1) / Math.sqrt(varS) : 0);
        const p = 2 * (1 - jStat.normal.cdf(Math.abs(Z), 0, 1));
        return p > 0.15 ? { text: "Stable", trend: "" } : (S > 0 ? { text: "Increasing ↗", trend: "trend-up" } : { text: "Decreasing ↘", trend: "trend-down" });
      };

      const getStats = (arr) => {
        const d = arr.filter(v => !isNaN(v));
        if (!d.length) return { n: 0, mean: NaN, median: NaN, stdev: NaN, min: NaN, max: NaN };
        return { n: d.length, mean: jStat.mean(d), median: jStat.median(d), stdev: jStat.stdev(d, true), min: jStat.min(d), max: jStat.max(d) };
      };

      try {
        const results = await Promise.all(urls.map(u => fetch(u.url).then(r => r.text())));
        results.forEach((csv, i) => {
          Papa.parse(csv, { header: true, skipEmptyLines: true }).data.forEach(r => {
            if (r.Country && /Brazil/i.test(r.Country)) {
              let entry = { year: urls[i].year, name: r["Name"] || r["University Name"] || r["institution"] };
              Object.keys(r).forEach(k => {
                let nk = k.trim();
                if(!["Country", "Name", "University Name", "institution", "year", "name", "Location"].includes(nk)) {
                  let val = parseVal(r[k]);
                  if(!isNaN(val)) {
                    entry[nk] = val;
                    allFoundMetrics.add(nk);
                  }
                }
              });
              rows.push(entry);
            }
          });
        });

        const unis = [...new Set(rows.map(r => r.name))].filter(n => n && n !== uffName).sort();
        const sel = document.getElementById("compareSelect");
        unis.forEach(u => sel.add(new Option(u, u)));

        const years = [...new Set(rows.map(r => r.year))].sort((a,b)=>a-b);
        years.forEach(y => {
          document.getElementById("minYear").add(new Option(y, y));
          document.getElementById("maxYear").add(new Option(y, y));
        });
        document.getElementById("maxYear").value = 2026;
        document.getElementById("status").innerHTML = '<i class="bi bi-check2-circle text-success"></i> Data Ready';

        const render = () => {
          const chartsDiv = document.getElementById("charts"); chartsDiv.innerHTML = "";
          const cmpName = document.getElementById("compareSelect").value;
          const startY = parseInt(document.getElementById("minYear").value);
          const endY = parseInt(document.getElementById("maxYear").value);
          const chartType = document.querySelector('input[name="chartType"]:checked').value;
          const labelsMode = document.querySelector('input[name="annMode"]:checked').value;

          Array.from(allFoundMetrics).sort().forEach(metric => {
            const uffD = rows.filter(r => r.name === uffName && r.year >= startY && r.year <= endY && r.hasOwnProperty(metric));
            const cmpD = cmpName ? rows.filter(r => r.name === cmpName && r.year >= startY && r.year <= endY && r.hasOwnProperty(metric)) : [];
            
            const uffY = uffD.map(r => r[metric]).filter(v => !isNaN(v));
            const uffX = uffD.filter(r => !isNaN(r[metric])).map(r => r.year);
            const cmpY = cmpD.map(r => r[metric]).filter(v => !isNaN(v));
            const cmpX = cmpD.filter(r => !isNaN(r[metric])).map(r => r.year);

            if (!uffY.length && !cmpY.length) return;

            const card = document.createElement("div"); card.className = "chart-card";
            card.innerHTML = `<div class="chart-header"><h3 class="chart-title">${metric}</h3></div>`;
            const body = document.createElement("div"); body.className = "chart-body";
            const plotDiv = document.createElement("div"); plotDiv.style.height = "250px";
            body.appendChild(plotDiv); card.appendChild(body); chartsDiv.appendChild(card);

            const isRank = metric.toLowerCase() === "rank";

            if (chartType === "line") {
              const traces = [{ x: uffX, y: uffY, name: "UFF", mode: 'lines+markers', line: { color: '#006064', width: 3 } }];
              if (cmpName && cmpY.length) traces.push({ x: cmpX, y: cmpY, name: cmpName, mode: 'lines+markers', line: { color: '#ff9800', width: 2, dash: 'dot' } });
              
              const anns = [];
              if (labelsMode !== 'none') {
                uffY.forEach((v, i) => anns.push({ x: uffX[i], y: v, text: isRank ? v : v.toFixed(1), showarrow: false, yanchor: 'bottom', yshift: 8, font: { size: 10, weight: 'bold', color: '#006064' } }));
                if (labelsMode === 'both') cmpY.forEach((v, i) => anns.push({ x: cmpX[i], y: v, text: isRank ? v : v.toFixed(1), showarrow: false, yanchor: 'top', yshift: -8, font: { size: 10, color: '#ff9800' } }));
              }

              Plotly.newPlot(plotDiv, traces, { 
                margin: { t: 40, l: 40, r: 20, b: 40 }, showlegend: true, legend: { orientation: "h", y: 1.25 },
                yaxis: { autorange: isRank ? "reversed" : true, gridcolor: "#eee" }, xaxis: { dtick: 1, gridcolor: "#eee" }, 
                annotations: anns, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
              }, { responsive: true, displaylogo: false });

              const ft = document.createElement("div"); ft.className = "stats-footer";
              const mkU = calculateMK(uffY);
              let h = `<div><strong>UFF Trend:</strong> <span class="${mkU.trend}">${mkU.text}</span></div>`;
              if (cmpName && cmpY.length > 3) { const mkC = calculateMK(cmpY); h += `<div><strong>${cmpName} Trend:</strong> <span class="${mkC.trend}">${mkC.text}</span></div>`; }
              ft.innerHTML = h; card.appendChild(ft);
            } else {
              // No boxplot, usamos o nome abreviado para os rótulos do eixo X
              const traces = [{ y: uffY, type: 'box', name: 'UFF', marker: { color: '#006064' } }];
              if (cmpName && cmpY.length) traces.push({ y: cmpY, type: 'box', name: abbreviate(cmpName), marker: { color: '#ff9800' } });
              
              Plotly.newPlot(plotDiv, traces, { 
                margin: { t: 40, l: 40, r: 20, b: 40 }, yaxis: { autorange: isRank ? "reversed" : true, gridcolor: "#eee" },
                xaxis: { showgrid: false }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
              }, { responsive: true, displaylogo: false });

              const sU = getStats(uffY), sC = cmpName ? getStats(cmpY) : null;
              const tableDiv = document.createElement("div");
              tableDiv.innerHTML = `
                <table class="table table-bordered table-sm table-stats">
                  <thead>
                    <tr><th>Metric</th><th>UFF (n=${sU.n})</th>${sC ? `<th>${abbreviate(cmpName)} (n=${sC.n})</th>` : ''}</tr>
                  </thead>
                  <tbody>
                    <tr><td>Mean</td><td>${fmt(sU.mean)}</td>${sC ? `<td>${fmt(sC.mean)}</td>` : ''}</tr>
                    <tr><td>Median</td><td>${fmt(sU.median)}</td>${sC ? `<td>${fmt(sC.median)}</td>` : ''}</tr>
                    <tr><td>Std Dev</td><td>${fmt(sU.stdev)}</td>${sC ? `<td>${fmt(sC.stdev)}</td>` : ''}</tr>
                    <tr><td>Min / Max</td><td>${fmt(sU.min)} / ${fmt(sU.max)}</td>${sC ? `<td>${fmt(sC.min)} / ${fmt(sC.max)}</td>` : ''}</tr>
                  </tbody>
                </table>`;
              body.appendChild(tableDiv);
            }
          });
        };

        // Reativação dos Event Listeners para atualização automática
        document.getElementById("compareSelect").addEventListener("change", render);
        document.getElementById("minYear").addEventListener("change", render);
        document.getElementById("maxYear").addEventListener("change", render);
        document.querySelectorAll('input[name="chartType"]').forEach(el => el.addEventListener("change", render));
        document.querySelectorAll('input[name="annMode"]').forEach(el => el.addEventListener("change", render));
        
        // Botões manuais mantidos
        document.getElementById("applyFilter").onclick = render;
        document.getElementById("refreshBtn").onclick = () => location.reload();
        
        render();
      } catch (e) { console.error(e); }
    })();
  </script>
</body>
</html>