<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>THE Rankings â€” UFF Comparison Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family:'Segoe UI',Roboto,Arial; margin:20px; background:#f5f7fa; color:#222; }
    h1 { margin-bottom:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .chart-card {
      background:#fff;
      border-radius:12px;
      padding:18px;
      border:1px solid #e2e2e2;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    footer { margin-top:18px; font-size:13px; color:#666; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>

<body>

<h1>THE Rankings â€” UFF Comparison Dashboard</h1>
<div class="text-muted mb-3"><strong>Developed by PGI/PLAN (UFF)</strong></div>

<!-- Controls -->
<div class="controls">
  <label class="fw-bold">Compare UFF with:</label>
  <select id="compareSelect" class="form-select w-auto">
    <option value="" selected disabled>Select an university</option>
  </select>
  <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
  <span id="status" class="text-muted">Loading data...</span>
</div>

<!-- Year filter -->
<div class="d-flex gap-3 align-items-end mb-3">
  <div>
    <label class="form-label mb-1">Start</label>
    <select id="minYear" class="form-select w-auto"></select>
  </div>

  <div>
    <label class="form-label mb-1">End</label>
    <select id="maxYear" class="form-select w-auto"></select>
  </div>

  <button id="applyFilter" class="btn btn-primary mb-1">Update</button>
</div>

<!-- Annotation controls -->
<div class="d-flex gap-3 align-items-center mb-3">
  <label class="fw-bold m-0">Annotations:</label>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="annMode" value="uff" checked>
    <label class="form-check-label">UFF only</label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="annMode" value="both">
    <label class="form-check-label">Both universities</label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="annMode" value="none">
    <label class="form-check-label">None</label>
  </div>
</div>

<!-- Charts -->
<div id="charts" class="grid"></div>

<footer>
  <strong>Data sources â€” THE:</strong>
  <a target="_blank"
     href="https://github.com/pjfernandes/university_ranking_data_visualizer/tree/main/times_higher_education">
     GitHub Repository
  </a>
</footer>

<script>
(async function(){

  const urls = [
    {year:2017,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2017.csv"},
    {year:2018,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2018.csv"},
    {year:2019,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2019.csv"},
    {year:2020,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2020.csv"},
    {year:2021,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2021.csv"},
    {year:2022,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2022.csv"},
    {year:2023,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2023.csv"},
    {year:2024,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2024.csv"},
    {year:2025,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2025.csv"},
    {year:2026,url:"https://raw.githubusercontent.com/pjfernandes/university_ranking_data_visualizer/main/times_higher_education/the_2026.csv"}
  ];

  const uffName = "Universidade Federal Fluminense";

  const chartsDiv = document.getElementById("charts");
  const compareSelect = document.getElementById("compareSelect");
  const minYear = document.getElementById("minYear");
  const maxYear = document.getElementById("maxYear");
  const statusEl = document.getElementById("status");

  let annotationMode = "uff";
  let rows = [];

  const parseNumber = v => {
    if(v==null) return NaN;
    const m = String(v).replace(",",".").match(/-?\d+(\.\d+)?/);
    return m ? +m[0] : NaN;
  };

  const pretty = s => s.replace(/[_\-]/g," ").replace(/\b\w/g,c=>c.toUpperCase());
  const isValid = v => typeof v==="number" && !isNaN(v);

  statusEl.textContent = "Loading CSVs...";

  const texts = await Promise.all(urls.map(u=>fetch(u.url).then(r=>r.text())));

  texts.forEach((txt,i)=>{
    Papa.parse(txt,{header:true,skipEmptyLines:true}).data.forEach(r=>{
      const o = {};
      Object.keys(r).forEach(k=>o[k.trim()] = r[k]);
      o.year = urls[i].year;
      rows.push(o);
    });
  });

  const brazil = rows.filter(r=>r.Country && /Brazil/i.test(r.Country));
  const nameKey = Object.keys(brazil[0]).find(k=>/name|institution|univ/i.test(k));

  const numericCols = Object.keys(brazil[0]).filter(c =>
    !["Country","Year","year",nameKey].includes(c) &&   // <<< FIX
    !/rank/i.test(c) &&
    brazil.some(r=>isValid(parseNumber(r[c])))
    );


  brazil.forEach(r=>numericCols.forEach(c=>r[c]=parseNumber(r[c])));

  [...new Set(brazil.map(r=>r[nameKey]))]
    .filter(n=>n && n!==uffName)
    .sort()
    .forEach(n=>compareSelect.add(new Option(n,n)));

  const years = [...new Set(brazil.map(r=>r.year))].sort();
  years.forEach(y=>{
    minYear.add(new Option(y,y));
    maxYear.add(new Option(y,y));
  });
  minYear.value = years[0];
  maxYear.value = years.at(-1);

  statusEl.textContent = "Ready";

  function render(compareTo=""){
    chartsDiv.innerHTML = "";

    const yr=[];
    for(let y=+minYear.value;y<=+maxYear.value;y++) yr.push(y);

    numericCols.forEach(metric=>{
      const card=document.createElement("div");
      card.className="chart-card";

      const title=document.createElement("div");
      title.innerHTML=`<strong>${pretty(metric)}</strong>`;

      const plot=document.createElement("div");
      plot.style.height="320px";

      card.append(title,plot);
      chartsDiv.appendChild(card);

      const uffY = yr.map(y=>{
        const d=brazil.find(r=>r[nameKey]===uffName && r.year===y);
        return d && isValid(d[metric]) ? d[metric] : null;
      });

      const cmpY = compareTo ? yr.map(y=>{
        const d=brazil.find(r=>r[nameKey]===compareTo && r.year===y);
        return d && isValid(d[metric]) ? d[metric] : null;
      }) : [];

      const traces = [{
        x: yr,
        y: uffY,
        mode: "lines+markers",
        name: uffName
      }];

      if(compareTo){
        traces.push({
          x: yr,
          y: cmpY,
          mode: "lines+markers",
          name: compareTo,
          line:{dash:"dash"}
        });
      }

      const annotations=[];
      yr.forEach((y,i)=>{
        if((annotationMode==="uff"||annotationMode==="both") && uffY[i]!=null){
          annotations.push({x:y,y:uffY[i],text:uffY[i].toFixed(2),showarrow:false,yanchor:"bottom",cliponaxis:false});
        }
        if(annotationMode==="both" && compareTo && cmpY[i]!=null){
          annotations.push({x:y,y:cmpY[i],text:cmpY[i].toFixed(2),showarrow:false,yanchor:"bottom",cliponaxis:false});
        }
      });

      Plotly.newPlot(plot,traces,{
  annotations,
  showlegend: true,
  margin:{t:60,l:70,r:40,b:60},
  xaxis:{title:"Year",dtick:1},
  yaxis:{title:pretty(metric)},
  legend:{orientation:"h",x:0,y:1.35}
},{responsive:true,displaylogo:false});
    });
  }

  // ðŸ‘‰ render inicial: SOMENTE UFF
  render("");

  compareSelect.onchange=e=>render(e.target.value || "");
  document.getElementById("applyFilter").onclick=()=>render(compareSelect.value || "");
  document.getElementById("refreshBtn").onclick=()=>location.reload();
  document.querySelectorAll("input[name='annMode']").forEach(r=>{
    r.onchange=e=>{annotationMode=e.target.value;render(compareSelect.value || "");}
  });

})();
</script>

</body>
</html>
